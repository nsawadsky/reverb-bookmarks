<html>
<embed type="application/x-reverb" id="reverbPlugin"></embed>
<script type="text/javascript" src="fancy-settings/source/lib/store.js"></script>
<script>
var GBL_settings = new Store("settings", {
  "ignoredAddresses": "www.google.com, www.google.ca"
});

var GBL_oldIgnoredAddresses = null;
var GBL_ignoredAddressesArray = null;

function getIgnoredAddresses() {
  var ignoredAddresses = GBL_settings.get("ignoredAddresses");
  if (ignoredAddresses != GBL_oldIgnoredAddresses) {
    GBL_oldIgnoredAddresses = ignoredAddresses;
    GBL_ignoredAddressesArray = ignoredAddresses.toLowerCase().split(',');
    
    for (var i = 0; i < GBL_ignoredAddressesArray.length; i++) {
      GBL_ignoredAddressesArray[i] = GBL_ignoredAddressesArray[i].replace(/^\s+|\s+$/g, "");
    }
  }
  return GBL_ignoredAddressesArray;
}

function extractHost(url) {
  var regexp = /^[^\:]+\:\/\/([^\/]+)/;
  var matches = url.match(regexp);
  if (matches == null) {
    return null;
  }
  return matches[1];
}

function initializePlugin() {
  var plugin = document.getElementById("reverbPlugin");
  if (plugin == null) {
    console.log("Failed to get plugin reference");
    return;
  }
  if (!plugin.startBackgroundThread()) {
    console.log("Failed to start background thread: " + plugin.getErrorMessage());
    return;
  }
  chrome.extension.onRequest.addListener(
      function(request, sender, sendResponse) {
        if (request.action == "updatePageContent") {
           if (!plugin.sendPage(request.url, request.page)) {
             console.log("Failed to send page: " + plugin.getErrorMessage());
             console.log("Background thread status: " + plugin.getBackgroundThreadStatus());
           }
          sendResponse({});
        } else if (request.action == "checkIndexPage") {
          var result = false;
          do {
            // Filter out frames loaded from different domains.
            var tabHost = extractHost(sender.tab.url);

            var ignoredAddresses = getIgnoredAddresses();
            if (ignoredAddresses != null && ignoredAddresses.indexOf(tabHost) != -1) {
              break;
            }
            result = true;
          } while (false);
          sendResponse({indexPage: result});
        }
      }
  );
}
initializePlugin();
</script>
</html>